name: Release macOS DMG

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos-dmg:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: npm ci

      - name: Build web frontend
        run: npm run build -w packages/web
        env:
          VITE_FIREBASE_API_KEY: AIzaSyA8NdosgijoZoOSTHoRY4XA5WH-58OF3Yk
          VITE_FIREBASE_AUTH_DOMAIN: botschat-130ff.firebaseapp.com
          VITE_FIREBASE_PROJECT_ID: botschat-130ff
          VITE_GA_MEASUREMENT_ID: G-HKJNG1X0JE

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: macos
        run: xcodegen generate

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$MACOS_CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
          security import "$RUNNER_TEMP/certificate.p12" \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

      - name: Build and archive
        working-directory: macos
        run: |
          xcodebuild archive \
            -project BotsChatMac.xcodeproj \
            -scheme BotsChatMac \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -archivePath "$RUNNER_TEMP/BotsChatMac.xcarchive" \
            MARKETING_VERSION="${{ steps.version.outputs.VERSION }}" \
            CURRENT_PROJECT_VERSION="${{ github.run_number }}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM=C5N5PPC329 \
            OTHER_CODE_SIGN_FLAGS="--keychain $RUNNER_TEMP/signing.keychain-db" \
            ARCHS="x86_64 arm64" \
            ONLY_ACTIVE_ARCH=NO

      - name: Export archive
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>teamID</key>
              <string>C5N5PPC329</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Developer ID Application</string>
          </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/BotsChatMac.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export"

      - name: Verify code signature
        run: |
          APP_PATH="$RUNNER_TEMP/export/BotsChat.app"
          echo "=== Code signature info ==="
          codesign -dvv "$APP_PATH"
          echo ""
          echo "=== Signature verification ==="
          codesign --verify --deep --strict "$APP_PATH"
          echo "Signature OK"

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_NAME="BotsChat-${VERSION}-mac.dmg"
          DMG_DIR="$RUNNER_TEMP/dmg-contents"

          mkdir -p "$DMG_DIR"
          cp -R "$RUNNER_TEMP/export/BotsChat.app" "$DMG_DIR/"
          ln -s /Applications "$DMG_DIR/Applications"

          hdiutil create \
            -volname "BotsChat" \
            -srcfolder "$DMG_DIR" \
            -ov \
            -format UDZO \
            "$RUNNER_TEMP/$DMG_NAME"

          codesign --force --sign "Developer ID Application" \
            --keychain "$KEYCHAIN_PATH" \
            "$RUNNER_TEMP/$DMG_NAME"

          echo "DMG_PATH=$RUNNER_TEMP/$DMG_NAME" >> "$GITHUB_ENV"
          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"

      - name: Submit for notarization (async, does not wait)
        continue-on-error: true
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          echo "Submitting $DMG_NAME for notarization..."
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "C5N5PPC329"
          echo ""
          echo "Notarization submitted. Check status later with:"
          echo "  xcrun notarytool history --apple-id <APPLE_ID> --password <APP_SPECIFIC_PASSWORD> --team-id C5N5PPC329"

      - name: Upload DMG to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.DMG_PATH }}
          generate_release_notes: true

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
